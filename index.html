<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Committee Quick Actions with History</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
      text-align: center;
    }
    .container {
      display: flex;
      flex-direction: column;
      align-items: center;
      margin-bottom: 20px;
    }
    .buttons-container {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 8px;
      margin-bottom: 15px;
    }
    button {
      padding: 10px 12px;
      font-size: 14px;
      cursor: pointer;
      border: none;
      border-radius: 5px;
      background-color: #007bff;
      color: white;
      transition: 0.3s;
    }
    button:hover {
      background-color: #0056b3;
    }
    /* Highlight the selected button in green */
    .selected {
      background-color: #28a745 !important;
    }
    .log {
      margin-top: 15px;
      padding: 10px;
      border: 1px solid #ddd;
      width: 90%;
      max-width: 600px;
      min-height: 50px;
      background: #f9f9f9;
      font-size: 16px;
      text-align: left;
      overflow-y: auto;
      transition: background 0.3s;
    }
    .log.copied {
      background: #d4edda;
    }
    .copy-btn {
      margin-top: 10px;
      background-color: #dc3545;
    }
    .copy-btn:hover {
      background-color: #c82333;
    }
    .section {
      width: 90%;
      max-width: 600px;
      margin: 10px 0;
      padding: 10px;
      border: 1px solid #ddd;
      background: #f1f1f1;
      text-align: center;
    }
    .hidden {
      display: none;
    }
    .vote-tally-controls {
      display: flex;
      justify-content: space-around;
      align-items: center;
      margin: 10px 0;
    }
    .vote-tally-controls div {
      display: flex;
      align-items: center;
      gap: 6px;
    }
    /* History Table */
    #historyTable {
      margin: 20px auto;
      width: 90%;
      max-width: 800px;
      border-collapse: collapse;
    }
    #historyTable th, #historyTable td {
      border: 1px solid #ccc;
      padding: 8px;
      text-align: left;
      vertical-align: middle;
    }
    #historyTable th {
      background: #f1f1f1;
    }
    .copy-row-button {
      background-color: #17a2b8;
      color: white;
      margin: 0;
      padding: 5px 8px;
      border-radius: 4px;
    }
    .copy-row-button:hover {
      background-color: #138496;
    }
  </style>
</head>
<body>

  <h2>Committee Quick Actions with History</h2>

  <div class="container">
    <label for="committeeSelect"><b>Select Committee:</b></label>
    <select id="committeeSelect" onchange="updateMembers()">
      <option value="energy">Energy & Natural Resources</option>
      <option value="judiciary">Judiciary</option>
    </select>

    <h3>Select Member:</h3>
    <div class="buttons-container" id="members-container"></div>

    <div class="section">
      <h3>Main Actions</h3>
      <div class="buttons-container">
        <button onclick="setMainAction(this, 'Moved')">Moved</button>
        <button onclick="setMainAction(this, 'Roll Call Vote on SB')">Roll Call Vote on SB</button>
        <button onclick="setMainAction(this, 'Roll Call Vote on Amendment')">Roll Call Vote on Amendment</button>
      </div>
    </div>

    <!-- Sub Actions for "Moved" only -->
    <div class="section hidden" id="sub-actions">
      <h3>Sub Actions (Moved)</h3>
      <div class="buttons-container" id="sub-actions-container"></div>
    </div>

    <!-- Bill Type section for "Moved" sub-action -->
    <div class="section hidden" id="bill-type-section">
      <h3>Select Bill Type</h3>
      <div class="buttons-container" id="bill-type-container"></div>
    </div>

    <!-- Optional "as Amended" for Roll Call Vote on SB -->
    <div class="section hidden" id="as-amended-section">
      <h3>Optional: As Amended?</h3>
      <div class="buttons-container">
        <button id="asAmendedBtn" onclick="toggleAsAmended(this)">As Amended</button>
      </div>
    </div>

    <!-- Vote Tally: for Roll Call Votes (SB or Amendment) -->
    <div class="section hidden" id="vote-tally-section">
      <h3>Vote Tally (FOR - AGAINST - NEUTRAL)</h3>
      <div class="vote-tally-controls">
        <div>
          <strong>For:</strong>
          <button onclick="incrementVote('for', true)">+</button>
          <span id="forCount">0</span>
          <button onclick="incrementVote('for', false)">-</button>
        </div>
        <div>
          <strong>Against:</strong>
          <button onclick="incrementVote('against', true)">+</button>
          <span id="againstCount">0</span>
          <button onclick="incrementVote('against', false)">-</button>
        </div>
        <div>
          <strong>Neutral:</strong>
          <button onclick="incrementVote('neutral', true)">+</button>
          <span id="neutralCount">0</span>
          <button onclick="incrementVote('neutral', false)">-</button>
        </div>
      </div>
    </div>

    <!-- Bill Carrier Section: only for "Roll Call Vote on SB" -->
    <div class="section hidden" id="bill-carrier-section">
      <h3>Select Bill Carrier</h3>
      <div class="buttons-container" id="bill-carrier-container"></div>
    </div>

    <div class="section">
      <h3>Meeting Actions</h3>
      <div class="buttons-container">
        <button onclick="appendMeetingAction('Closed Hearing')">Closed Hearing</button>
        <button onclick="appendMeetingAction('Recessed Meeting')">Recessed Meeting</button>
        <button onclick="appendMeetingAction('Adjourned Meeting')">Adjourned Meeting</button>
        <button onclick="appendMeetingAction('Reconvened Meeting')">Reconvened Meeting</button>
        <!-- Special: "Seconded" has no dash in the final statement -->
        <button onclick="appendMeetingAction('Seconded')">Seconded</button>
      </div>
    </div>

    <!-- Copy button + Auto Copy checkbox + Reset All button -->
    <div style="margin-top:10px;">
      <button class="copy-btn" onclick="copyToClipboard()">ðŸ“‹ Copy to Clipboard (Ctrl + Enter)</button>
      <label style="margin-left: 10px;">
        <input type="checkbox" id="autoCopyCheckbox" onchange="onAutoCopyChanged()" />
        Auto Copy
      </label>
      <button style="margin-left:10px; background-color:#6c757d; color:white; padding:10px;" onclick="resetAllAndFinalize()">Reset All</button>
    </div>

    <h3>Constructed Statement:</h3>
    <div class="log" id="log">[Click a member and an action]</div>
  </div>

  <!-- History Table for completed statements -->
  <h3>History of Statements</h3>
  <table id="historyTable">
    <thead>
      <tr>
        <th>Timestamp</th>
        <th>Statement</th>
        <th>Copy</th>
      </tr>
    </thead>
    <tbody id="historyTableBody"></tbody>
  </table>

  <script>
    /* --------------------------
       Global Variables & Setup
       -------------------------- */
    let selectedMember = "";
    let mainAction = "";
    let selectedSubAction = "";   // For "Moved" => "Do Pass" or "Do Not Pass"
    let selectedBillType = "";    // For "Moved" => "SB", "HB", or "Amendment"
    let selectedCarrier = "";     // Only for "Roll Call Vote on SB"
    let constructedStatement = "";
    let currentCommittee = "";
    let asAmended = false;        // For Roll Call Vote on SB "as Amended" toggle
    let autoCopyEnabled = false;

    // For the statement in progress
    let forVal = 0;
    let againstVal = 0;
    let neutralVal = 0;

    // In-progress row references
    let inProgressRow = null;
    let statementCell = null;
    let statementStartTime = null; // The moment we first pick the new member

    // Committees
    const committees = {
      energy: [
        "Chairman Dale Patton",
        "Vice Chairman Greg Kessel",
        "Senator Todd Beard",
        "Senator Keith Boehm",
        "Senator Mark Enget",
        "Senator Justin Gerhardt",
        "Senator Desiree Van Oosting"
      ],
      judiciary: [
        "Chairwoman Diane Larson",
        "Vice Chairman Bob Paulson",
        "Senator Jose Castaneda",
        "Senator Claire Cory",
        "Senator Larry Luick",
        "Senator Janne Myrdal",
        "Senator Ryan Braunberger"
      ]
    };

    /* --------------------------
       Utility Functions
       -------------------------- */
    function getCurrentTimestamp() {
      // Format e.g. "3:05:07 PM" or "15:05:07" if you prefer 24h
      const now = new Date();
      // Let's do a simple HH:MM:SS p style
      return now.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit', second:'2-digit'});
    }

    function createNewRowInHistory() {
      // Create new row, store references
      const tableBody = document.getElementById("historyTableBody");
      inProgressRow = document.createElement("tr");

      // 1) Timestamp cell
      const timeCell = document.createElement("td");
      timeCell.textContent = statementStartTime; // e.g. "3:05:07 PM"
      inProgressRow.appendChild(timeCell);

      // 2) Statement cell
      statementCell = document.createElement("td");
      statementCell.textContent = constructedStatement;
      inProgressRow.appendChild(statementCell);

      // 3) Copy button cell
      const copyCell = document.createElement("td");
      const copyButton = document.createElement("button");
      copyButton.textContent = "Copy";
      copyButton.classList.add("copy-row-button");
      copyButton.onclick = () => {
        navigator.clipboard.writeText(statementCell.textContent);
      };
      copyCell.appendChild(copyButton);
      inProgressRow.appendChild(copyCell);

      tableBody.appendChild(inProgressRow);
    }

    // Update the statement cell text as user changes it
    function updateInProgressRow() {
      if (inProgressRow && statementCell) {
        statementCell.textContent = constructedStatement;
      }
    }

    // Finalize the current row (stop updating it)
    function finalizeInProgressRow() {
      inProgressRow = null;
      statementCell = null;
      statementStartTime = null;
    }

    /* --------------------------
       Auto Copy
       -------------------------- */
    function onAutoCopyChanged() {
      autoCopyEnabled = document.getElementById("autoCopyCheckbox").checked;
      // If turning ON and we already have a statement
      if (autoCopyEnabled && constructedStatement.trim() !== "[Click a member and an action]" && constructedStatement.trim() !== "") {
        copyToClipboard();
      }
    }

    function autoCopyIfEnabled() {
      if (autoCopyEnabled) {
        copyToClipboard(false); 
      }
    }

    /* --------------------------
       Main UI Flow
       -------------------------- */
    function updateMembers() {
      currentCommittee = document.getElementById("committeeSelect").value;
      resetSelections();

      const membersContainer = document.getElementById("members-container");
      membersContainer.innerHTML = "";
      committees[currentCommittee].forEach(member => {
        const btn = document.createElement("button");
        btn.innerText = member;
        btn.onclick = () => selectMember(member, btn);
        membersContainer.appendChild(btn);
      });
    }

    // Called each time we pick a new member
    // If there's an in-progress statement, we add it to the table first
    function selectMember(member, btn) {
      // If we have a non-empty statement in progress, finalize that row
      if (constructedStatement && constructedStatement !== "[Click a member and an action]" && constructedStatement.trim() !== "") {
        updateInProgressRow(); // ensure final text is saved
        finalizeInProgressRow();
      }

      // Now reset everything
      resetSelections(false); // skip finalizing row again (we just did above)

      // Start fresh with this new statement
      selectedMember = member;
      // We record the timestamp from the first click => so let's store statementStartTime
      statementStartTime = getCurrentTimestamp();
      // Create a new row in history for in-progress statement
      createNewRowInHistory();

      updateStatement();

      // Highlight the selected member
      document.querySelectorAll("#members-container button").forEach(b => b.classList.remove("selected"));
      btn.classList.add("selected");
    }

    function setMainAction(button, action) {
      if (!selectedMember) {
        alert("Please select a member first!");
        return;
      }
      mainAction = action;
      selectedSubAction = "";
      selectedBillType = "";
      selectedCarrier = "";
      asAmended = false; 

      updateStatement();

      // Highlight the selected main action
      document.querySelectorAll(".section:nth-of-type(2) button").forEach(b => b.classList.remove("selected"));
      button.classList.add("selected");

      // Show/hide relevant sections
      if (action === "Moved") {
        showMovedSubActions();
        showVoteTallySection(false);
        showBillCarrierSection(false);
        showAsAmendedSection(false);
      }
      else if (action === "Roll Call Vote on SB") {
        document.getElementById("sub-actions").classList.add("hidden");
        document.getElementById("bill-type-section").classList.add("hidden");
        showVoteTallySection(true);
        showBillCarrierSection(true);
        showAsAmendedSection(true); 
      }
      else if (action === "Roll Call Vote on Amendment") {
        document.getElementById("sub-actions").classList.add("hidden");
        document.getElementById("bill-type-section").classList.add("hidden");
        showVoteTallySection(true);
        showBillCarrierSection(false);
        showAsAmendedSection(false);
      }
    }

    /* "Moved" => sub-actions => "Do Pass" / "Do Not Pass" */
    function showMovedSubActions() {
      const subActionsContainer = document.getElementById("sub-actions-container");
      subActionsContainer.innerHTML = "";
      document.getElementById("sub-actions").classList.remove("hidden");

      const subActions = ["Do Pass", "Do Not Pass"];
      subActions.forEach(subAction => {
        const btn = document.createElement("button");
        btn.innerText = subAction;
        btn.onclick = () => handleMovedSubAction(btn, subAction);
        subActionsContainer.appendChild(btn);
      });
    }

    function handleMovedSubAction(button, subAction) {
      selectedSubAction = subAction;
      updateStatement();

      // Highlight chosen sub action
      document.querySelectorAll("#sub-actions-container button").forEach(b => b.classList.remove("selected"));
      button.classList.add("selected");

      // Show Bill Type: "SB", "HB", "Amendment"
      showBillTypeSection(true);
    }

    // Bill Type => "SB", "HB", or "Amendment"
    function showBillTypeSection(visible) {
      const billTypeSection = document.getElementById("bill-type-section");
      if (visible) {
        billTypeSection.classList.remove("hidden");
        const billTypeContainer = document.getElementById("bill-type-container");
        billTypeContainer.innerHTML = "";

        const types = ["SB", "HB", "Amendment"];
        types.forEach(t => {
          const btn = document.createElement("button");
          btn.innerText = t;
          btn.onclick = () => selectBillType(t, btn);
          billTypeContainer.appendChild(btn);
        });
      } else {
        billTypeSection.classList.add("hidden");
      }
    }

    function selectBillType(type, btn) {
      selectedBillType = type;
      updateStatement();

      // Highlight the chosen bill type
      document.querySelectorAll("#bill-type-container button").forEach(b => b.classList.remove("selected"));
      btn.classList.add("selected");
    }

    // "As Amended" button for Roll Call Vote on SB
    function showAsAmendedSection(visible) {
      const asAmendedSec = document.getElementById("as-amended-section");
      if (visible) {
        asAmendedSec.classList.remove("hidden");
      } else {
        asAmendedSec.classList.add("hidden");
      }
    }

    function toggleAsAmended(btn) {
      asAmended = !asAmended;
      // Toggle highlight
      if (asAmended) {
        btn.classList.add("selected");
      } else {
        btn.classList.remove("selected");
      }
      updateStatement();
    }

    // Vote Tally
    function showVoteTallySection(visible) {
      const tallySec = document.getElementById("vote-tally-section");
      if (visible) {
        tallySec.classList.remove("hidden");
        resetVoteTally();
      } else {
        tallySec.classList.add("hidden");
      }
    }

    // Bill Carrier (only for "Roll Call Vote on SB")
    function showBillCarrierSection(visible) {
      const carrierSection = document.getElementById("bill-carrier-section");
      if (visible) {
        carrierSection.classList.remove("hidden");
        const carrierContainer = document.getElementById("bill-carrier-container");
        carrierContainer.innerHTML = "";

        committees[currentCommittee].forEach(member => {
          const btn = document.createElement("button");
          btn.innerText = member;
          btn.onclick = () => selectBillCarrier(member, btn);
          carrierContainer.appendChild(btn);
        });
      } else {
        carrierSection.classList.add("hidden");
      }
    }

    function selectBillCarrier(member, btn) {
      selectedCarrier = member;
      document.querySelectorAll("#bill-carrier-container button").forEach(b => b.classList.remove("selected"));
      btn.classList.add("selected");
      updateStatement();
    }

    // Tally increment/decrement
    function incrementVote(type, isIncrement) {
      if (type === 'for') {
        if (isIncrement) forVal++;
        else if (forVal > 0) forVal--;
      } else if (type === 'against') {
        if (isIncrement) againstVal++;
        else if (againstVal > 0) againstVal--;
      } else if (type === 'neutral') {
        if (isIncrement) neutralVal++;
        else if (neutralVal > 0) neutralVal--;
      }
      document.getElementById('forCount').innerText = forVal;
      document.getElementById('againstCount').innerText = againstVal;
      document.getElementById('neutralCount').innerText = neutralVal;

      updateStatement();
    }

    function getMotionResultText() {
      // ties are fail
      if (forVal > againstVal) {
        return "Motion Passed";
      } else {
        return "Motion Failed";
      }
    }

    /* 
      The main function that rebuilds the constructedStatement each time
      something changes.
    */
    function updateStatement() {
      if (!selectedMember) {
        document.getElementById("log").innerText = "[Click a member and an action]";
        return;
      }

      let parts = [];

      // 1) "Roll Call Vote on SB" or "Roll Call Vote on Amendment"
      if (mainAction === "Roll Call Vote on SB" || mainAction === "Roll Call Vote on Amendment") {
        let actionText = mainAction; // e.g. "Roll Call Vote on SB"
        if (mainAction === "Roll Call Vote on SB" && asAmended) {
          actionText = "Roll Call Vote on SB as Amended";
        }
        parts.push(actionText);

        // If there's a tally, show pass/fail + counts
        parts.push(getMotionResultText());
        parts.push(`${forVal}-${againstVal}-${neutralVal}`);

        // Carrier if "Roll Call Vote on SB" & selectedCarrier
        if (actionText.includes("SB") && selectedCarrier) {
          parts.push(`${selectedCarrier} Carried the Bill`);
        }
      }
      // 2) "Moved"
      else if (mainAction === "Moved") {
        // e.g. "Chairman Dale Patton - Moved Do Pass on SB"
        parts.push(selectedMember);
        if (selectedSubAction && selectedBillType) {
          parts.push(`Moved ${selectedSubAction} on ${selectedBillType}`);
        } else if (selectedSubAction) {
          parts.push(`Moved ${selectedSubAction}`);
        } else {
          parts.push("Moved");
        }
      }
      // 3) Some other action
      else if (mainAction) {
        parts.push(`${selectedMember} - ${mainAction}`);
      }

      // If we ended up with no parts, show default
      if (parts.length === 0) {
        constructedStatement = "[Click a member and an action]";
      } else {
        constructedStatement = parts.join(" - ");
      }

      document.getElementById("log").innerText = constructedStatement;

      // Update in-progress row
      updateInProgressRow();

      // Possibly auto copy
      autoCopyIfEnabled();
    }

    function resetVoteTally() {
      forVal = 0;
      againstVal = 0;
      neutralVal = 0;
      document.getElementById('forCount').innerText = 0;
      document.getElementById('againstCount').innerText = 0;
      document.getElementById('neutralCount').innerText = 0;
    }

    // Meeting actions
    function appendMeetingAction(action) {
      if (!selectedMember) {
        alert("Please select a member first!");
        return;
      }
      if (action === "Seconded") {
        constructedStatement = `${selectedMember} Seconded`;
      } else {
        constructedStatement = `${selectedMember} - ${action}`;
      }
      document.getElementById("log").innerText = constructedStatement;
      updateInProgressRow(); 
      autoCopyIfEnabled();
    }

    /* -------------
       Copy to Clipboard
       ------------- */
    function copyToClipboard(highlight = true) {
      if (!constructedStatement || constructedStatement.startsWith("[Click a member")) {
        return;
      }
      navigator.clipboard.writeText(constructedStatement);
      if (highlight) {
        const log = document.getElementById("log");
        log.classList.add("copied");
        setTimeout(() => log.classList.remove("copied"), 1000);
      }
    }

    /* -------------
       Reset Logic
       ------------- */
    // "Reset All" button
    // If we have an in-progress statement, finalize it
    // Then do a fresh reset
    function resetAllAndFinalize() {
      if (constructedStatement && constructedStatement !== "[Click a member and an action]" && constructedStatement.trim() !== "") {
        updateInProgressRow(); // update final text
      }
      finalizeInProgressRow();
      resetSelections();
    }

    // The main reset (optionally skip finalizing the row if we already did)
    function resetSelections(finalize = true) {
      if (finalize && constructedStatement && constructedStatement !== "[Click a member and an action]" && constructedStatement.trim() !== "") {
        updateInProgressRow();
      }
      if (finalize) {
        finalizeInProgressRow();
      }

      selectedMember = "";
      mainAction = "";
      selectedSubAction = "";
      selectedBillType = "";
      selectedCarrier = "";
      asAmended = false;
      constructedStatement = "";

      resetVoteTally();

      // Hide relevant sections
      document.getElementById("sub-actions").classList.add("hidden");
      document.getElementById("bill-type-section").classList.add("hidden");
      document.getElementById("vote-tally-section").classList.add("hidden");
      document.getElementById("bill-carrier-section").classList.add("hidden");
      document.getElementById("as-amended-section").classList.add("hidden");

      // Remove .selected from all buttons
      document.querySelectorAll("button").forEach(b => b.classList.remove("selected"));

      // Reset log text
      document.getElementById("log").innerText = "[Click a member and an action]";
    }

    // Support Ctrl + Enter to copy
    document.addEventListener("keydown", function(event) {
      if (event.ctrlKey && event.key === "Enter") {
        copyToClipboard();
      }
    });

    // Initialize
    updateMembers();
  </script>
</body>
</html>
